name: Deploy to Environments

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'Trigger Development deployment (true/false)'
        required: false
        default: false
        type: boolean

jobs:

  build:
    name: Build Application
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.artifact.outputs.name }}
      docker-image-tag: ${{ steps.mock_docker.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create artifact name
        id: artifact
        run: echo "name=build-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: app/
          retention-days: 30

      - name: Mock publish Docker image
        id: mock_docker
        if: github.ref == 'refs/heads/main' || github.event.inputs.deploy == true
        run: |
          IMAGE_TAG=demo-app:${GITHUB_SHA}
          echo "Mock publishing Docker image with tag $IMAGE_TAG"
          sleep 2
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT



  deploy-dev:
    name: Deploy to Development (${{ matrix.region }} - ${{ matrix.aws_region }})
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' || github.event.inputs.deploy == true
    strategy:
      matrix:
        include:
          - region: US East 1
            aws_region: us-east-1
            url: https://dev-us-east-1.example.com
            bucket: dev-us-east-1-bucket
          - region: EU Central 1
            aws_region: eu-central-1
            url: https://dev-eu-central-1.example.com
            bucket: dev-eu-central-1-bucket
          - region: AP Southeast 1
            aws_region: ap-southeast-1
            url: https://dev-ap-southeast-1.example.com
            bucket: dev-ap-southeast-1-bucket
    environment:
      name: dev
      url: ${{ matrix.url }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: dist/

      - name: Use Docker image tag
        run: |
          echo "Using Docker image tag: ${{ needs.build.outputs.docker-image-tag }}"

      - name: Deploy to Development (${{ matrix.region }})
        env:
          AWS_REGION: ${{ matrix.aws_region }}
        run: |
          echo "üöÄ Deploying to Development environment (${{ matrix.region }})..."
          echo "Environment: dev"
          echo "Region: ${{ matrix.aws_region }}"
          echo "Artifact: ${{ needs.build.outputs.artifact-name }}"
          echo "Docker Image Tag: ${{ needs.build.outputs.docker-image-tag }}"
          echo "SHA: ${{ github.sha }}"
          # Add your deployment commands here
          # Example: aws s3 sync dist/ s3://${{ matrix.bucket }}/ --region ${{ matrix.aws_region }}
          sleep 3
          echo "‚úÖ Development deployment to ${{ matrix.region }} completed!"

      - name: Run smoke tests (${{ matrix.region }})
        run: |
          echo "üß™ Running smoke tests on dev environment (${{ matrix.region }})..."
          # Add your smoke test commands here
          sleep 2
          echo "‚úÖ Smoke tests passed in ${{ matrix.region }}!"


  deploy-rc:
    name: Deploy to Release Candidate (${{ matrix.region }} - ${{ matrix.aws_region }})
    runs-on: ubuntu-latest
    needs: [build, deploy-dev]
    strategy:
      matrix:
        include:
          - region: US East 1
            aws_region: us-east-1
            url: https://rc-us-east-1.example.com
            bucket: rc-us-east-1-bucket
          - region: EU Central 1
            aws_region: eu-central-1
            url: https://rc-eu-central-1.example.com
            bucket: rc-eu-central-1-bucket
          - region: AP Southeast 1
            aws_region: ap-southeast-1
            url: https://rc-ap-southeast-1.example.com
            bucket: rc-ap-southeast-1-bucket
    environment:
      name: rc
      url: ${{ matrix.url }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: dist/

      - name: Deploy to Release Candidate (${{ matrix.region }})
        env:
          AWS_REGION: ${{ matrix.aws_region }}
        run: |
          echo "üöÄ Deploying to Release Candidate environment (${{ matrix.region }})..."
          echo "Environment: rc"
          echo "Region: ${{ matrix.aws_region }}"
          echo "Artifact: ${{ needs.build.outputs.artifact-name }}"
          echo "SHA: ${{ github.sha }}"
          # Add your deployment commands here
          # Example: aws s3 sync dist/ s3://${{ matrix.bucket }}/ --region ${{ matrix.aws_region }}
          sleep 3
          echo "‚úÖ RC deployment to ${{ matrix.region }} completed!"

      - name: Run integration tests (${{ matrix.region }})
        run: |
          echo "üß™ Running integration tests on RC environment (${{ matrix.region }})..."
          # Add your integration test commands here
          sleep 3
          echo "‚úÖ Integration tests passed in ${{ matrix.region }}!"


  deploy-stage:
    name: Deploy to Staging (${{ matrix.region }} - ${{ matrix.aws_region }})
    runs-on: ubuntu-latest
    needs: [build, deploy-rc]
    strategy:
      matrix:
        include:
          - region: US East 1
            aws_region: us-east-1
            url: https://stage-us-east-1.example.com
            bucket: stage-us-east-1-bucket
          - region: EU Central 1
            aws_region: eu-central-1
            url: https://stage-eu-central-1.example.com
            bucket: stage-eu-central-1-bucket
          - region: AP Southeast 1
            aws_region: ap-southeast-1
            url: https://stage-ap-southeast-1.example.com
            bucket: stage-ap-southeast-1-bucket
    environment:
      name: stage
      url: ${{ matrix.url }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: dist/

      - name: Deploy to Staging (${{ matrix.region }})
        env:
          AWS_REGION: ${{ matrix.aws_region }}
        run: |
          echo "üöÄ Deploying to Staging environment (${{ matrix.region }})..."
          echo "Environment: stage"
          echo "Region: ${{ matrix.aws_region }}"
          echo "Artifact: ${{ needs.build.outputs.artifact-name }}"
          echo "SHA: ${{ github.sha }}"
          # Add your deployment commands here
          # Example: aws s3 sync dist/ s3://${{ matrix.bucket }}/ --region ${{ matrix.aws_region }}
          sleep 4
          echo "‚úÖ Staging deployment to ${{ matrix.region }} completed!"

      - name: Run end-to-end tests (${{ matrix.region }})
        run: |
          echo "üß™ Running end-to-end tests on staging environment (${{ matrix.region }})..."
          # Add your E2E test commands here
          sleep 4
          echo "‚úÖ End-to-end tests passed in ${{ matrix.region }}!"

      - name: Notify stakeholders
        if: ${{ matrix.region == 'AP Southeast 1' }}
        run: |
          echo "üìß Notifying stakeholders about staging deployment..."
          echo "Staging environments are ready for review:"
          echo "- US East 1: https://stage-us-east-1.example.com"
          echo "- EU Central 1: https://stage-eu-central-1.example.com"
          echo "- AP Southeast 1: https://stage-ap-southeast-1.example.com"


  deploy-prod:
    name: Deploy to Production (${{ matrix.region }} - ${{ matrix.aws_region }})
    runs-on: ubuntu-latest
    needs: [build, deploy-stage]
    strategy:
      matrix:
        include:
          - region: US East 1
            aws_region: us-east-1
            url: https://us-east-1.example.com
            bucket: prod-us-east-1-bucket
          - region: EU Central 1
            aws_region: eu-central-1
            url: https://eu-central-1.example.com
            bucket: prod-eu-central-1-bucket
          - region: AP Southeast 1
            aws_region: ap-southeast-1
            url: https://ap-southeast-1.example.com
            bucket: prod-ap-southeast-1-bucket
    environment:
      name: prod
      url: ${{ matrix.url }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: dist/

      - name: Deploy to Production (${{ matrix.region }})
        env:
          AWS_REGION: ${{ matrix.aws_region }}
        run: |
          echo "üöÄ Deploying to Production environment (${{ matrix.region }})..."
          echo "Environment: prod"
          echo "Region: ${{ matrix.aws_region }}"
          echo "Artifact: ${{ needs.build.outputs.artifact-name }}"
          echo "SHA: ${{ github.sha }}"
          # Add your deployment commands here
          # Example: aws s3 sync dist/ s3://${{ matrix.bucket }}/ --region ${{ matrix.aws_region }}
          sleep 5
          echo "‚úÖ Production deployment to ${{ matrix.region }} completed!"

      - name: Verify production deployment (${{ matrix.region }})
        run: |
          echo "üîç Verifying production deployment (${{ matrix.region }})..."
          # Add your verification commands here
          sleep 2
          echo "‚úÖ Production verification completed in ${{ matrix.region }}!"

      - name: Send success notification
        if: ${{ matrix.region == 'AP Southeast 1' }}
        run: |
          echo "üéâ Production deployment successful across all regions!"
          echo "Applications are live at:"
          echo "- US East 1: https://us-east-1.example.com"
          echo "- EU Central 1: https://eu-central-1.example.com"
          echo "- AP Southeast 1: https://ap-southeast-1.example.com"
          echo "Version: ${{ github.sha }}"
